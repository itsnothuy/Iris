#!/bin/bash
# Pre-commit hook for iris_android
# Runs ktlint and basic checks before allowing commit

set -e

echo "üîç Running pre-commit checks..."

# Check if we're in the right directory
if [ ! -f "gradlew" ]; then
    echo "‚ùå Error: gradlew not found. Are you in the project root?"
    exit 1
fi

# Run ktlint check on staged Kotlin files
STAGED_KT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.kt$" || true)

if [ -n "$STAGED_KT_FILES" ]; then
    echo "üìù Checking Kotlin code style with ktlint..."
    
    # Run ktlint only on staged files
    for file in $STAGED_KT_FILES; do
        if [ -f "$file" ]; then
            echo "  Checking $file"
        fi
    done
    
    # Run ktlint check
    ./gradlew ktlintCheck --quiet 2>&1 | grep -v "^Download" || {
        echo "‚ùå ktlint check failed. Run './gradlew ktlintFormat' to auto-fix issues."
        exit 1
    }
    
    echo "‚úÖ ktlint check passed"
else
    echo "‚ÑπÔ∏è  No Kotlin files to check"
fi

# Check for common issues
echo "üîé Checking for common issues..."

# Check for TODO/FIXME markers in staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
for file in $STAGED_FILES; do
    if [ -f "$file" ] && grep -q "TODO.*#issue" "$file" 2>/dev/null; then
        echo "‚ö†Ô∏è  Warning: $file contains TODO markers referencing issues"
    fi
done

# Check for debuggable=true in release builds
if echo "$STAGED_FILES" | grep -q "build.gradle"; then
    if grep -r "debuggable true" --include="*.gradle*" app/build.gradle* 2>/dev/null | grep -q "release"; then
        echo "‚ùå Error: debuggable=true found in release build configuration"
        exit 1
    fi
fi

# Check for hardcoded secrets (simple check)
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        if grep -iE "(api[_-]?key|secret|password|token)\s*=\s*['\"][^'\"]{8,}" "$file" 2>/dev/null; then
            echo "‚ö†Ô∏è  Warning: Possible hardcoded secret in $file"
            echo "   Please verify no sensitive data is being committed"
        fi
    fi
done

echo "‚úÖ Pre-commit checks passed!"
exit 0
